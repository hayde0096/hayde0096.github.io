<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>更衣人偶</title>
  <style>
    /* 保持原有样式不变 */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin: 20px 0 20px;
      color: #2c3e50;
      font-size: 2em;
    }

    .issues-notice {
      text-align: center;
      margin: 20px 0 40px;
      color: #666;
      font-size: 14px;
    }

    .issues-link {
      color: #2ea44f;
      text-decoration: none;
      border-bottom: 1px dotted #2ea44f;
      transition: all 0.2s;
    }

    .issues-link:hover {
      color: #22863a;
      border-bottom-style: solid;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .image-item {
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      min-height: 400px;
    }

    .image-container {
      flex: 1;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #eee;
    }

    .image-container img {
      max-width: 100%;
      max-height: 300px;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    .description-box {
      height: 100px;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .description-text {
      width: 100%;
      margin: 0;
      line-height: 1.4;
      color: #555;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      word-break: break-word;
      overflow: hidden;
    }

    .description-text:active {
      transform: scale(0.98);
    }

    @media (max-width: 600px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .image-container img {
        max-height: 250px;
      }
      
      h1 {
        font-size: 1.8em;
      }
    }
  </style>
</head>
<body>
  <h1>更衣人偶</h1>
  
  <p class="issues-notice">
    想要提交的衣服可以提交在
    <a href="https://github.com/hayde0096/Kisegaeningyou/issues" 
       class="issues-link"
       target="_blank"
       rel="noopener noreferrer">
      Issues中
    </a>
  </p>

  <div id="image-grid" class="grid"></div>

  <script>
    // 配置信息
    const CONFIG = {
      REPO_OWNER: 'hayde0096',
      REPO_NAME: 'Kisegaeningyou',
      IMAGE_FOLDER: 'images'
    };

    // 增强版Base64解码函数
    function decodeBase64Content(base64Str) {
      if (!base64Str) {
        console.warn('Base64内容为空');
        return '说明内容为空';
      }
      
      try {
        let safeBase64 = base64Str
          .replace(/-/g, '+')
          .replace(/_/g, '/');

        const padLength = (4 - (safeBase64.length % 4)) % 4;
        safeBase64 += '='.repeat(padLength);

        const decoded = atob(safeBase64);
        return decodeURIComponent(escape(decoded));
      } catch (error) {
        console.error('解码失败:', {
          input: base64Str,
          error: error.message
        });
        return '说明解析失败';
      }
    }

    // 文字缩放函数
    function autoShrinkText(element) {
      const container = element.parentElement;
      let fontSize = 16;
      element.style.fontSize = fontSize + 'px';
      
      while (element.scrollHeight > container.offsetHeight && fontSize > 5) {
        fontSize -= 0.5;
        element.style.fontSize = fontSize + 'px';
      }
    }

    // 创建图片卡片
    function createImageCard(imgUrl, description) {
      const card = document.createElement('div');
      card.className = 'image-item';
      
      const imgContainer = document.createElement('div');
      imgContainer.className = 'image-container';
      
      const img = new Image();
      img.src = imgUrl;
      img.onload = () => {
        img.style.opacity = 1;
        requestAnimationFrame(() => autoShrinkText(descText));
      };
      img.style.opacity = 0;
      img.style.transition = 'opacity 0.3s';
      
      const descBox = document.createElement('div');
      descBox.className = 'description-box';
      
      const descText = document.createElement('div');
      descText.className = 'description-text';
      descText.textContent = description || '暂无说明';
      
      descText.addEventListener('click', () => {
        navigator.clipboard.writeText(description)
          .then(() => {
            const originalText = descText.textContent;
            descText.textContent = '已复制 ✓';
            setTimeout(() => {
              descText.textContent = originalText;
              autoShrinkText(descText);
            }, 1000);
          });
      });

      imgContainer.appendChild(img);
      descBox.appendChild(descText);
      card.appendChild(imgContainer);
      card.appendChild(descBox);

      return card;
    }

    // 加载画廊数据（增强版）
    async function loadGallery() {
      try {
        console.log('开始加载画廊数据...');
        const filesRes = await fetch(
          `https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.IMAGE_FOLDER}`
        );
        
        if (!filesRes.ok) {
          throw new Error(`HTTP错误! 状态码: ${filesRes.status}`);
        }

        const allFiles = await filesRes.json();
        console.log('GitHub API响应数据:', allFiles);

        const imageFiles = allFiles.filter(file => {
          const isImage = file.name.match(/\.(jpg|jpeg|png|gif)$/i);
          const isDescFile = file.name.endsWith('.desc.txt');
          console.log(`文件: ${file.name} | 图片: ${isImage} | 说明文件: ${isDescFile}`);
          return isImage && !isDescFile;
        });

        console.log('过滤后的图片文件:', imageFiles);

        const grid = document.getElementById('image-grid');
        grid.innerHTML = ''; // 清空现有内容

        // 使用Promise.all处理异步加载
        await Promise.all(imageFiles.map(async (file) => {
          try {
            const descFileName = `${file.name}.desc.txt`;
            console.log(`处理图片: ${file.name}，查找说明文件: ${descFileName}`);

            const descFile = allFiles.find(f => f.name === descFileName);
            let description = '暂无说明';

            if (descFile) {
              console.log('找到说明文件:', descFile);
              
              // 处理大文件情况（GitHub API不返回content）
              let content = descFile.content;
              if (!content && descFile.size > 0) {
                console.log('单独获取说明文件内容...');
                const descRes = await fetch(descFile.download_url);
                const textContent = await descRes.text();
                content = btoa(unescape(encodeURIComponent(textContent)));
              }

              if (content) {
                console.log('原始Base64内容:', content);
                description = decodeBase64Content(content);
                console.log('解码结果:', description);
              }
            }

            grid.appendChild(createImageCard(file.download_url, description));
          } catch (error) {
            console.error(`处理文件 ${file.name} 时出错:`, error);
          }
        }));

      } catch (error) {
        console.error('加载失败:', error);
        const grid = document.getElementById('image-grid');
        grid.innerHTML = `<p style="text-align:center;color:#dc3545;">数据加载失败，请刷新重试</p>`;
      }
    }

    // 窗口尺寸变化处理
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        document.querySelectorAll('.description-text').forEach(autoShrinkText);
      }, 200);
    });

    // 初始化加载
    window.addEventListener('DOMContentLoaded', loadGallery);
  </script>
</body>
</html>